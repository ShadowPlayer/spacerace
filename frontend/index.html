<!doctype html>
<html>
<head>
    <title>Spacerace</title>
    <meta name="viewport" content="width=device-width, minimum-scale=1.0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font: 13px Helvetica, Arial;
        }

        polygon.shipWings {
            opacity: 0.8;
        }

        polygon.shipStripe {
            fill: black;
        }

        circle.shipBody {
            stroke-width: 1px;
        }

        line.shipJet {
            stroke-width: 10px;
            stroke: black;
        }

        use {
            will-change: transform;
        }


    </style>

</head>
<body>
<svg id="game"></svg>
<div id="fps">FPS: <span>?</span></div>
<div id="leaderboard"></div>

<script src="socket.io/socket.io.js"></script>
<script src="d3/d3.min.js"></script>

<script>
    var socket = io();
    var requestID;
    var gameState;
    var lastUpdateTime;

    var updates = 0;
    var draws = 0;
    var fpsqueue = [];

    socket.on('GameState', function (msg) {
        var rawPacket = JSON.parse(msg);
        //console.log(rawPacket);

        if(rawPacket.status === "IN GAME") {
            gameState = rawPacket.data;
            updates += 1;

            if (updates == 1) {
                setupGame()
            }
        }

        if(rawPacket.status === "GAME OVER"){
            console.log("Game Over");
        }
    });

    //socket.on('GameMap', function (msg) {
    //    var data = JSON.parse(msg).data;
    //    setupGame(data)
    //}


</script>
<script>
    var width = 720;

    /*
     * TODO: Need to find out the real size/aspect ratio of the
     * image so we draw our ships correctly
     * */
    var ASPECT = 1500/1078;
    var height = width / ASPECT;

    var svgContainer = d3.select('#game')
            .attr("width", width)
            .attr("height", height);

    var map = svgContainer.append("image")
        .attr("id", "GameMap")
        .attr("width", width)
        .attr("height", height)
        .attr("xlink:href", "map.png");

    var fps = d3.select("#fps span");

    // Assume positions are between 0 and 100 for now
    // (0,0) is at the bottom left
    var x = d3.scale.linear().domain([0, 100]).range([0, width]);
    var y = d3.scale.linear().domain([0, 100]).range([height, 0]);

    var shipG = svgContainer.append("defs")
            .append("symbol")
            .attr("viewBox", "0 0 50 50")
            .attr("id", "ship")
            .attr("class", "ship");

    shipG.append("polygon")
        .attr("points", "25,2 47,37 3,37")
        .attr("class", "shipWings");

    // For now the jet "backwards" is simply a solid line
    shipG.append("line")
            .attr("class", "shipJet")
            .attr("x1", 25)
            .attr("y1", 35)
            .attr("x2", 25)
            .attr("y2", 45);

    // Main circular body of the ship
    shipG.append("circle")
            .attr("class", "shipBody")
            .attr('cx', 25)
            .attr('cy', 25)
            .attr('r', function (d, i) { return 16; });


    shipG.append("polygon")
            .attr("points", "23,30 27,30 25,5")
            .attr("class", "shipStripe");



    var shipGroup = svgContainer.append("g").attr("id", "shipsParentGroup");

    var ships;

    var splineFunction = d3.svg.line()
        .x(function(d) { return x(d.x); })
        .y(function(d) { return y(d.y); })
        .interpolate("basis");

    var lineFunction = d3.svg.line()
        .x(function(d) { return x(d.x); })
        .y(function(d) { return y(d.y); })
        .interpolate("linear");


    var setupGame = function() {
        var initState = gameState;
        var SHIPSIZE = "10";

        ships = shipGroup
            .selectAll('.ship')
            .data(initState)
            .enter()
            .append('use')
            .attr("transform", function(d, i){return "translate(0, 0)";})
            .attr("id", function(d, i){return "ship"+i;})
            .attr("xlink:href", "#ship")
            .attr("width", SHIPSIZE)
            .attr("height", SHIPSIZE)
            .attr('fill', function () {
                return "hsl(" + Math.random() * 360 + ",75%, 50%)"
            });

        // Trigger the first full draw
        updateState();

    };

    var updateState = function (highResTimestamp){


        requestID = requestAnimationFrame(updateState);



        if(updates >= draws) {
            // Only update the ships if we have gotten an update from the server
            draws += 1;

            // Calculate an fps counter
            if (fpsqueue.length >= 100) { fps.text(d3.mean(fpsqueue).toFixed(0)); fpsqueue = fpsqueue.slice(1, 100); }
            fpsqueue.push(Math.round(1000 / (highResTimestamp - lastUpdateTime)));
            lastUpdateTime = highResTimestamp;


            ships
                .data(gameState)
                // Perhaps we can add/remove the jet with display="none"
                //.attr('opacity', function (d, i) {
                //    // Show accelerating with opacity toggle
                //    var accelerating = d.Tl == 1;
                //    return accelerating ? 1.0 : 0.2;
                //})
                .attr("x", function (d, i) {return x(d.x);})
                .attr("y", function (d, i) {return y(d.y);})
                .attr("transform", function (d, i) {
                    // It is possible to both update ships' position and rotation using a single SVG transform/rotation
                    // command however it doesn't seem as performant as using the x,y attributes as above.
                    // Note SVG rotate takes degrees not radians, and it also takes positon (X, Y)
                    // to center the rotation around.
                    var shipX = x(d.x),
                        shipY = y(d.y);

                    return "rotate(" +
                            (90 - d.theta * 360/(2*Math.PI)) +
                            "," + shipX + ", " + shipY +
                            ")";
                });
        }
    }

</script>
</body>
</html>