<!doctype html>
<html>
<head>
    <title>Spacerace</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font: 13px Helvetica, Arial;
        }

        path.mapBorder {
            stroke: steelblue;
            stroke-width: 10px;
            fill: none;
        }
        path.startLine {
            stroke: black;
            stroke-width: 2px;
            stroke-dasharray: 5px;
            fill: none;
        }
        path.finishLine {
            stroke: red;
            stroke-width: 2px;
            stroke-dasharray: 5px;
            fill: none;
        }

        polygon.startZone {
            opacity: 0.2;
            stroke: black;
            stroke-width: 5px;
            fill: none;
        }

    </style>

</head>
<body>

<svg id="game"></svg>
<div id="leaderboard"></div>

<script src="socket.io/socket.io.js"></script>
<script src="d3/d3.min.js"></script>

<script>
    var socket = io();

    var updates = 0;

    socket.on('GameState', function (msg) {
        var data = JSON.parse(msg).data;
        updates += 1;
        if(updates % 100 == 0){
            console.log("Tick")
        }

        if(updates == 1){
            setupGame(data)
        }

        updateState(data);
    });

    //socket.on('GameMap', function (msg) {
    //    var data = JSON.parse(msg).data;
    //    setupGame(data)
    //}


</script>
<script>
    var width = 720,
        height = 500;

    var svgContainer = d3.select('#game')
            .attr("width", width)
            .attr("height", height);



    // Assume positions are between 0 and 100 for now
    var x = d3.scale.linear().domain([0, 100]).range([0, width]);
    var y = d3.scale.linear().domain([0, 100]).range([0, height]);

    var shipG = svgContainer.append("defs")
            .append("symbol")
            .attr("viewBox", "0 0 10 10")
            .attr("id", "ship")
            .attr("class", "ship");

    shipG.append("circle")
        .attr('r', function (d, i) { return 8; });

    shipG.append("line")
            .attr("stroke", "black")
            .attr("stroke-width", 2)
            .attr("x1", 0)
            .attr("y1", 0)
            .attr("x2", 10)
            .attr("y2", 10);

    var shipGroup = svgContainer.append("g");
    var map = svgContainer.append("g");
    var ships;

    var splineFunction = d3.svg.line()
        .x(function(d) { return x(d.x); })
        .y(function(d) { return y(d.y); })
        .interpolate("basis");

    var lineFunction = d3.svg.line()
        .x(function(d) { return x(d.x); })
        .y(function(d) { return y(d.y); })
        .interpolate("linear");


    /**
     * Still have to work out how we will do maps...
     * But for now lets draw two splines
     */
    var startZone = [
        {"x": 0,   "y": 0},
        {"x": 0,   "y": 25},
        {"x": 25.0,"y": 25},
        {"x": 25.0,"y": 0}];

    var startLineData = [
        { "x": 25,   "y": 5},
        { "x": 25,   "y": 25}
    ];
    var finishLineData = [
        { "x": 90,   "y": 80},
        { "x": 80,   "y": 80}
    ];

    var lineDataTop = [
        { "x": 25,   "y": 5},
        { "x": 27,   "y": 5},
        { "x": 28,  "y": 20},
        { "x": 40,  "y": 10},
        { "x": 60,  "y": 40},
        { "x": 80,  "y": 5},
        { "x": 90, "y": 60},
        { "x": 90, "y": 80}
    ];
    var lineDataBottom = [
        { "x": 25,   "y": 20 + 5},
        { "x": 25,   "y": 20 + 5},
        { "x": Math.random(10) + 25,  "y": 20 + 20},
        { "x": Math.random(10) + 40,  "y": 20 + 10},
        { "x": Math.random(10) + 60,  "y": 20 + 40},
        { "x": Math.random(10) + 80,  "y": 20 + 5},
        { "x": 80, "y": 20 + 60}
    ];

    var setupGame = function(initState) {
        ships = shipGroup
            .selectAll('.ship')
            .data(initState)
            .enter()
            .append('use')
            .attr("xlink:href", "#ship")
            .attr("width", "10")
            .attr("height", "10")
            .attr('fill', function () {
                return "hsl(" + Math.random() * 360 + ",100%, 50%)"
            });

        map.append("path")
            .attr("class", "mapBorder")
            .attr("d", splineFunction(lineDataTop));

        map.append("path")
            .attr("class", "mapBorder")
            .attr("d", splineFunction(lineDataBottom));

        map.append("path")
            .attr("class", "startLine")
            .attr("d", lineFunction(startLineData));

        map.append("path")
            .attr("class", "finishLine")
            .attr("d", lineFunction(finishLineData));

        map.selectAll("polygon")
            .data([startZone])
            .enter().append("polygon")
            .attr("class", "startZone")
            .attr("points",function(d) {
                return d.map(function(d){return [x(d.x),y(d.y)].join(","); }).join(" ");})
            .attr("stroke","black")
            .attr("stroke-width",2);


    };

    var updateState = function (newState){
        ships
            .attr('x', function (d, i) { return x(newState[i].position[0]); })
            .attr('y', function (d, i) { return y(newState[i].position[1]); })
//            .attr("transform", function(d, i){
//                   return "rotate(" + 90 + ")";
//                });

    }

</script>
</body>
</html>